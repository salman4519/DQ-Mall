<%- include('../layouts/header.ejs') %>

<%- include('../layouts/sidebar.ejs') %>
    <!-- partial -->
    <div class="container-fluid page-body-wrapper">
      <!-- partial:partials/_navbar.html -->
      <nav class="navbar p-0 fixed-top d-flex flex-row">
        <div class="navbar-brand-wrapper d-flex d-lg-none align-items-center justify-content-center">
          <a class="navbar-brand brand-logo-mini" href="index.html"><img src="/admin/assets/images/logo-mini.svg"
              alt="logo" /></a>
        </div>
        <div class="navbar-menu-wrapper flex-grow d-flex align-items-stretch">
          <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
            <span class="mdi mdi-menu"></span>
          </button>
          <ul class="navbar-nav w-100">
            <li class="nav-item w-100">
              <form class="nav-link mt-2 mt-md-0 d-none d-lg-flex search">
                <input type="text" class="form-control" placeholder="Search products">
              </form>
            </li>
          </ul>
          <ul class="navbar-nav navbar-nav-right">
            <div class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list"
              aria-labelledby="createbuttonDropdown">
              <h6 class="p-3 mb-0">Projects</h6>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item preview-item">
                <div class="preview-thumbnail">
                  <div class="preview-icon bg-dark rounded-circle">
                    <i class="mdi mdi-file-outline text-primary"></i>
                  </div>
                </div>
                <div class="preview-item-content">
                  <p class="preview-subject ellipsis mb-1">Software Development</p>
                </div>
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item preview-item">
                <div class="preview-thumbnail">
                  <div class="preview-icon bg-dark rounded-circle">
                    <i class="mdi mdi-web text-info"></i>
                  </div>
                </div>
                <div class="preview-item-content">
                  <p class="preview-subject ellipsis mb-1">UI Development</p>
                </div>
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item preview-item">
                <div class="preview-thumbnail">
                  <div class="preview-icon bg-dark rounded-circle">
                    <i class="mdi mdi-layers text-danger"></i>
                  </div>
                </div>
                <div class="preview-item-content">
                  <p class="preview-subject ellipsis mb-1">Software Testing</p>
                </div>
              </a>
              <div class="dropdown-divider"></div>
              <p class="p-3 mb-0 text-center">See all projects</p>
            </div>
            </li>
            <li class="nav-item nav-settings d-none d-lg-block">
              <a class="nav-link" href="#">
                <i class="mdi mdi-view-grid"></i>
              </a>
            </li>
            <li class="nav-item dropdown border-left">
              <a class="nav-link count-indicator dropdown-toggle" id="messageDropdown" href="#" data-toggle="dropdown"
                aria-expanded="false">
                <i class="mdi mdi-email"></i>
                <span class="count bg-success"></span>
              </a>
              <div class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list"
                aria-labelledby="messageDropdown">
                <h6 class="p-3 mb-0">Messages</h6>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <img src="/admin/assets/images/faces/face4.jpg" alt="image" class="rounded-circle profile-pic">
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject ellipsis mb-1">Mark send you a message</p>
                    <p class="text-muted mb-0"> 1 Minutes ago </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <img src="/admin/assets/images/faces/face2.jpg" alt="image" class="rounded-circle profile-pic">
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject ellipsis mb-1">Cregh send you a message</p>
                    <p class="text-muted mb-0"> 15 Minutes ago </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <img src="/admin/assets/images/faces/face3.jpg" alt="image" class="rounded-circle profile-pic">
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject ellipsis mb-1">Profile picture updated</p>
                    <p class="text-muted mb-0"> 18 Minutes ago </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <p class="p-3 mb-0 text-center">4 new messages</p>
              </div>
            </li>
            <li class="nav-item dropdown border-left">
              <a class="nav-link count-indicator dropdown-toggle" id="notificationDropdown" href="#"
                data-toggle="dropdown">
                <i class="mdi mdi-bell"></i>
                <span class="count bg-danger"></span>
              </a>
              <div class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list"
                aria-labelledby="notificationDropdown">
                <h6 class="p-3 mb-0">Notifications</h6>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-calendar text-success"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject mb-1">Event today</p>
                    <p class="text-muted ellipsis mb-0"> Just a reminder that you have an event today </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-settings text-danger"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject mb-1">Settings</p>
                    <p class="text-muted ellipsis mb-0"> Update dashboard </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-link-variant text-warning"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject mb-1">Launch Admin</p>
                    <p class="text-muted ellipsis mb-0"> New admin wow! </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <p class="p-3 mb-0 text-center">See all notifications</p>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link" id="profileDropdown" href="#" data-toggle="dropdown">
                <div class="navbar-profile">
                  <img class="img-xs rounded-circle" src="/admin/assets/images/faces/face15.jpg" alt="">
                  <p class="mb-0 d-none d-sm-block navbar-profile-name">Henry Klein</p>
                  <i class="mdi mdi-menu-down d-none d-sm-block"></i>
                </div>
              </a>
              <div class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list"
                aria-labelledby="profileDropdown">
                <h6 class="p-3 mb-0">Profile</h6>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-settings text-success"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject mb-1">Settings</p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-logout text-danger"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject mb-1">Log out</p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <p class="p-3 mb-0 text-center">Advanced settings</p>
              </div>
            </li>
          </ul>
          <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button"
            data-toggle="offcanvas">
            <span class="mdi mdi-format-line-spacing"></span>
          </button>
        </div>
      </nav>

      <!-- main  -->

      <div class="main-panel">
        <div class="content-wrapper">
          <div class="row">
            <div class="col-12 grid-margin stretch-card">
              <div class="card corona-gradient-card">
                <div class="card-body py-0 px-0 px-sm-3">
                  <div class="row align-items-center">
                    <div class="col-4 col-sm-3 col-xl-2">
                      <img src="assets/images/dashboard/Group126@2x.png" class="gradient-corona-img img-fluid" alt="">
                    </div>
                    <div class="col-5 col-sm-7 col-xl-8 p-0 ">
                      <h1 class="mb-1 mb-sm-0">Order Management</h1>

                    </div>
                    <div class="col-3 col-sm-2 col-xl-2 pl-0 text-center">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <h4 class="card-title">Orders</h4>
                  <p class="card-description"> All your orders with their details </p>
                  <div class="table-responsive">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>No</th>
                          <th>Order ID</th>
                          <th>Payment Method</th>
                          <th>Status</th>
                          <th>Total Price</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% orders.forEach((order , index )=> { %>
                          <tr>
                            <td>
                              <%= index + 1 %>
                            </td>
                            <td>
                              <%= order.OrderId %>
                            </td>
                            <td>
                              <%= order.PaymentMethod %>
                            </td>
                            <td>
                              <div class="d-flex align-items-center">
                                  <!-- Display the status as a colored badge -->
                                  <span class="badge badge-<%= order.Status === 'Returned' ? 'warning' : order.Status === 'Delivered' ? 'success' : order.Status === 'Pending' ? 'dark' : order.Status === 'Shipped' ? 'primary' : 'danger' %> status-label"
                                        style="cursor: pointer;"
                                        data-order-id="<%= order.OrderId %>">
                                      <%= order.Status %>
                                  </span>
                                  
                                  <!-- Dropdown options, hidden by default -->
                                  <div id="dropdown-<%= order.OrderId %>" class="dropdown-options d-none">
                                      <% if (order.Status === 'Pending') { %>
                                          <select class="form-control order-status-select" data-order-id="<%= order.OrderId %>">
                                              <option value="">Select Status</option>
                                              <option value="Shipped">Shipped</option>
                                              <option value="Delivered">Delivered</option>
                                          </select>
                                      <% } else if (order.Status === 'Shipped') { %>
                                          <select class="form-control order-status-select" data-order-id="<%= order.OrderId %>">
                                              <option value="">Select Status</option>
                                              <option value="Delivered">Delivered</option>
                                          </select>
                                      <% } %>
                                  </div>
                              </div>
                          </td>
                            <td>$<%= order.TotalPrice.toFixed(2) %>
                            </td>
                            <td>
                              <button class="btn btn-primary view-order-btn" data-order-id="<%= order.OrderId %>"
                                data-toggle="modal" data-target="#orderModal">View</button>

                              <% if (order.Status !=='Cancelled' && order.Status !=='Delivered' && order.Status !=='Returned' ) { %>
                                <button class="btn btn-danger cancel-order-btn"
                                  data-order-id="<%= order.OrderId %>">Cancel</button>
                                <% } %>
                                <% if ( order.Status =='Delivered' ) { %>
                                  <button class="btn btn-warning return-order-btn"
                                    data-order-id="<%= order.OrderId %>">Return</button>
                                  <% } %>
                            </td>
                          </tr>
                          <% }) %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- //padination -->
          <div class="pagination-container">
            <nav aria-label="Page navigation">
              <ul class="pagination justify-content-center">
                <% if (currentPage> 1) { %>
                  <li class="page-item">
                    <a class="page-link" href="?page=<%= currentPage - 1 %>" aria-label="Previous">
                      <span aria-hidden="true">&laquo;</span>
                    </a>
                  </li>
                  <% } %>
                    <% for (let i=1; i <=totalPages; i++) { %>
                      <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                        <a class="page-link" href="?page=<%= i %>">
                          <%= i %>
                        </a>
                      </li>
                      <% } %>
                        <% if (currentPage < totalPages) { %>
                          <li class="page-item">
                            <a class="page-link" href="?page=<%= currentPage + 1 %>" aria-label="Next">
                              <span aria-hidden="true">&raquo;</span>
                            </a>
                          </li>
                          <% } %>
              </ul>
            </nav>
          </div>

          <!-- Modal for Viewing Order Details -->
          <div class="modal fade" id="orderModal" tabindex="-1" role="dialog" aria-labelledby="orderModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="orderModalLabel">Order Details</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <div id="orderDetailsContent">
                    <p>Loading order details...</p>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>

          <script>
            document.querySelectorAll('.order-status-select').forEach(select => {
                select.addEventListener('change', function () {
                    const orderId = this.dataset.orderId;
                    const newStatus = this.value;
        
                    // Check if a valid status is selected
                    if (!newStatus) {
                        alert('Please select a status.');
                        return;
                    }
        
                    // Make an API call to update the order status
                    fetch('/admin/update-order-status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ orderId: orderId, newStatus: newStatus }), // Send orderId and newStatus in the request body
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to update status: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        alert(data.message); // Display success message
                        location.reload(); // Reload to show updated order status
                    })
                    .catch(error => {
                        alert(`Error: ${error.message}`);
                    });
                });
            });
        
            // Handle click on the status label to show/hide dropdown
            document.querySelectorAll('.status-label').forEach(label => {
                label.addEventListener('click', function () {
                    const orderId = this.dataset.orderId;
                    const dropdown = document.getElementById(`dropdown-${orderId}`);
                    dropdown.classList.toggle('d-none');
                });
            });
        </script>
        
        
          <script>
            // Handle order cancellation
            document.querySelectorAll('.cancel-order-btn').forEach(button => {
              button.addEventListener('click', function () {
                const orderId = this.dataset.orderId;

                // Make an API call to cancel the order
                fetch('/admin/cancel-order', { // Adjusted endpoint to match the controller
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ orderId: orderId }), // Send orderId in the request body
                })
                  .then(response => {
                    if (!response.ok) {
                      throw new Error(`Failed to cancel order: ${response.statusText}`);
                    }
                    return response.json();
                  })
                  .then(data => {
                    alert(data.message); // Display success message
                    location.reload(); // Reload to show updated order status
                  })
                  .catch(error => {
                    alert(`Error: ${error.message}`);
                  });
              });
            });

            // Handle order cancellation
            document.querySelectorAll('.return-order-btn').forEach(button => {
              button.addEventListener('click', function () {
                const orderId = this.dataset.orderId;

                // Make an API call to cancel the order
                fetch('/admin/return-order', { // Adjusted endpoint to match the controller
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ orderId: orderId }), // Send orderId in the request body
                })
                  .then(response => {
                    if (!response.ok) {
                      throw new Error(`Failed to return order: ${response.statusText}`);
                    }
                    return response.json();
                  })
                  .then(data => {
                    alert(data.message); // Display success message
                    location.reload(); // Reload to show updated order status
                  })
                  .catch(error => {
                    alert(`Error: ${error.message}`);
                  });
              });
            });

            
            
          </script>

          <script>
            // Fetch and display order details in the modal
            document.querySelectorAll('.view-order-btn').forEach(button => {
              button.addEventListener('click', function () {
                const orderId = this.dataset.orderId;

                // Set the modal title with the order ID
                document.getElementById('orderModalLabel').textContent = `Order Details (ID: ${orderId})`;

                // Clear previous order details and show a loading message
                document.getElementById('orderDetailsContent').innerHTML = '<p>Loading order details...</p>';

                // Fetch the order details using orderId
                fetch(`/admin/order-details/${orderId}`)
                  .then(response => {
                    if (!response.ok) {
                      throw new Error(`Failed to load order details: ${response.statusText}`);
                    }
                    return response.json();
                  })
                  .then(order => {
                    // Check if TotalPrice is defined and is a number
                    const totalPrice = typeof order.TotalPrice === 'number' ? order.TotalPrice.toFixed(2) : 'N/A';

                    // Format the shipping address
                    const shippingAddress = order.ShippingAddress
                      ? ` ${order.ShippingAddress.FullName},${order.ShippingAddress.City}, ${order.ShippingAddress.Country}, ${order.ShippingAddress.Pincode}`
                      : 'N/A';

                    // Populate the modal with order details
                    const orderDetailsHtml = `
            <p><strong>Order ID:</strong> ${order.OrderId}</p>
            <p><strong>Payment Method:</strong> ${order.PaymentMethod || 'N/A'}</p>
            <p><strong>Status:</strong> <label class="badge badge-${order.Status === 'Returned' ? 'warning' :order.Status === 'Delivered' ? 'success' : order.Status === 'Pending' ? 'dark' : order.Status === 'Shipped' ? 'primary' : 'danger'}">${order.Status}</label></p>
            <p><strong>Total Price:</strong> $${totalPrice}</p>
            <h5>Products:</h5>
            <ul>
              ${order.Products.map(product => `
                <li>${product.Name} (Quantity: ${product.Quantity})</li>
              `).join('')}
            </ul>
            <p><strong>Shipping Address:</strong> ${shippingAddress}</p>
          `;

                    document.getElementById('orderDetailsContent').innerHTML = orderDetailsHtml;
                  })
                  .catch(error => {
                    document.getElementById('orderDetailsContent').innerHTML = `<p>Error loading order details: ${error.message}</p>`;
                  });
              });
            });
          </script>




          <%- include('../layouts/footer.ejs') %>