<%- include('../layouts/header.ejs') %>
<%- include('../layouts/sidebar.ejs') %>
    <!-- partial -->
    <div class="container-fluid page-body-wrapper">
      <!-- partial:partials/_navbar.html -->
      <nav class="navbar p-0 fixed-top d-flex flex-row">
        <div class="navbar-brand-wrapper d-flex d-lg-none align-items-center justify-content-center">
          <a class="navbar-brand brand-logo-mini" href="index.html"><img src="/admin/assets/images/logo-mini.svg" alt="logo" /></a>
        </div>
        <div class="navbar-menu-wrapper flex-grow d-flex align-items-stretch">
          <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
            <span class="mdi mdi-menu"></span>
          </button>
          <ul class="navbar-nav w-100">
            <li class="nav-item w-100">
              <form class="nav-link mt-2 mt-md-0 d-none d-lg-flex search">
                <input type="text" class="form-control" placeholder="Search products">
              </form>
            </li>
          </ul>
          <ul class="navbar-nav navbar-nav-right">
            <li class="nav-item dropdown d-none d-lg-block">
              
              
              <div class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list" aria-labelledby="createbuttonDropdown">
                <h6 class="p-3 mb-0">Projects</h6>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-file-outline text-primary"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject ellipsis mb-1">Software Development</p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-web text-info"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject ellipsis mb-1">UI Development</p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-layers text-danger"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject ellipsis mb-1">Software Testing</p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <p class="p-3 mb-0 text-center">See all projects</p>
              </div>
            </li>
            <li class="nav-item nav-settings d-none d-lg-block">
              <a class="nav-link" href="#">
                <i class="mdi mdi-view-grid"></i>
              </a>
            </li>
            <li class="nav-item dropdown border-left">
              <a class="nav-link count-indicator dropdown-toggle" id="messageDropdown" href="#" data-toggle="dropdown" aria-expanded="false">
                <i class="mdi mdi-email"></i>
                <span class="count bg-success"></span>
              </a>
              <div class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list" aria-labelledby="messageDropdown">
                <h6 class="p-3 mb-0">Messages</h6>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <img src="/admin/assets/images/faces/face4.jpg" alt="image" class="rounded-circle profile-pic">
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject ellipsis mb-1">Mark send you a message</p>
                    <p class="text-muted mb-0"> 1 Minutes ago </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <img src="/admin/assets/images/faces/face2.jpg" alt="image" class="rounded-circle profile-pic">
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject ellipsis mb-1">Cregh send you a message</p>
                    <p class="text-muted mb-0"> 15 Minutes ago </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <img src="/admin/assets/images/faces/face3.jpg" alt="image" class="rounded-circle profile-pic">
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject ellipsis mb-1">Profile picture updated</p>
                    <p class="text-muted mb-0"> 18 Minutes ago </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <p class="p-3 mb-0 text-center">4 new messages</p>
              </div>
            </li>
            <li class="nav-item dropdown border-left">
              <a class="nav-link count-indicator dropdown-toggle" id="notificationDropdown" href="#" data-toggle="dropdown">
                <i class="mdi mdi-bell"></i>
                <span class="count bg-danger"></span>
              </a>
              <div class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list" aria-labelledby="notificationDropdown">
                <h6 class="p-3 mb-0">Notifications</h6>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-calendar text-success"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject mb-1">Event today</p>
                    <p class="text-muted ellipsis mb-0"> Just a reminder that you have an event today </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-settings text-danger"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject mb-1">Settings</p>
                    <p class="text-muted ellipsis mb-0"> Update dashboard </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-link-variant text-warning"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject mb-1">Launch Admin</p>
                    <p class="text-muted ellipsis mb-0"> New admin wow! </p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <p class="p-3 mb-0 text-center">See all notifications</p>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link" id="profileDropdown" href="#" data-toggle="dropdown">
                <div class="navbar-profile">
                  <img class="img-xs rounded-circle" src="/admin/assets/images/faces/face15.jpg" alt="">
                  <p class="mb-0 d-none d-sm-block navbar-profile-name">Henry Klein</p>
                  <i class="mdi mdi-menu-down d-none d-sm-block"></i>
                </div>
              </a>
              <div class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list" aria-labelledby="profileDropdown">
                <h6 class="p-3 mb-0">Profile</h6>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-settings text-success"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject mb-1">Settings</p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-logout text-danger"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject mb-1">Log out</p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <p class="p-3 mb-0 text-center">Advanced settings</p>
              </div>
            </li>
          </ul>
          <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
            <span class="mdi mdi-format-line-spacing"></span>
          </button>
        </div>
      </nav>

      <!-- main  -->

      <div class="main-panel">
        <div class="content-wrapper">
          <!-- upper image -->
      <div class="row">
        <div class="col-12 grid-margin stretch-card">
          <div class="card corona-gradient-card">
            <div class="card-body py-0 px-0 px-sm-3">
              <div class="row align-items-center">
                <div class="col-4 col-sm-3 col-xl-2">
                  <img src="/admin/assets/images/dashboard/Group126@2x.png" class="gradient-corona-img img-fluid" alt="">
                </div>
                <div class="col-5 col-sm-7 col-xl-8 p-0">
                  <h3 class="mb-1 mb-sm-0">Dashboard</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-6 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Area chart</h4>
                    <canvas id="areaChart" style="height:250px"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Doughnut chart</h4>
                    <canvas id="doughnutChart" style="height:250px"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
      <div class="col-12 grid-margin stretch-card">
          <div class="card">
              <div class="card-body">
                  <h4 class="card-title">Delivered Orders</h4>
                  <p class="card-description">All your delivered orders with their details</p>
  
                  <!-- Sales Report Filter Form -->
                  <form id="salesReportForm" action="/admin/download-sales-report" method="post" class="d-flex justify-content-between align-items-center">
                      <!-- Filter Options -->
                      <div class="form-group me-2">
                          <label class="me-2">View:</label>
                          <div>
                              <input type="radio" id="daily" name="reportType" value="daily" checked>
                              <label for="daily">Daily</label>
                              <input type="radio" id="monthly" name="reportType" value="monthly" class="ms-2">
                              <label for="monthly">Monthly</label>
                              <input type="radio" id="yearly" name="reportType" value="yearly" class="ms-2">
                              <label for="yearly">Yearly</label>
                              <input type="radio" id="custom" name="reportType" value="custom" class="ms-2">
                              <label for="custom">Custom</label>
                          </div>
                      </div>
  
                      <!-- Date Range for Custom View -->
                      <div class="form-group me-2 custom-date-range" style="display: none;">
                          <label for="startDate" class="me-2">Start Date:</label>
                          <input type="date" id="startDate" name="startDate" class="form-control me-2">
                          <label for="endDate" class="me-2">End Date:</label>
                          <input type="date" id="endDate" name="endDate" class="form-control">
                      </div>
  
                      <button id="downloadPDFBtn" type="button" class="btn btn-primary me-2">Download PDF</button>
                      <button id="downloadExcelBtn" type="button" class="btn btn-secondary">Download Excel</button>
                  </form>
  
                  <div id="loadingIndicator" style="display:none;">Loading...</div>
                  <div id="errorMessage" style="color: red; display: none;"></div>
  
                  <div class="table-responsive mt-3">
                      <table class="table">
                          <thead>
                              <tr>
                                  <th>No</th>
                                  <th>Order ID</th>
                                  <th>Payment Method</th>
                                  <th>Status</th>
                                  <th>Total Price</th>
                                  <th>Discount</th>
                                  <th>Order Date</th>
                              </tr>
                          </thead>
                          <tbody>
                              <% if (orders.length > 0) { %>
                                  <% orders.forEach((order, index) => { %>
                                      <tr>
                                          <td><%= index + 1 %></td>
                                          <td><%= order.OrderId %></td>
                                          <td><%= order.PaymentMethod %></td>
                                          <td>
                                              <span class="badge badge-success status-label"><%= order.Status %></span>
                                          </td>
                                          <td>$<%= order.TotalPrice.toFixed(2) %></td>
                                          <td>
                                              <% if (order.DiscountedPrice && order.DiscountedPrice > 0) { %>
                                                  $<%= order.DiscountedPrice.toFixed(2) %>
                                              <% } else { %>
                                                  No Discount
                                              <% } %>
                                          </td>
                                          <td><%= new Date(order.createdAt).toLocaleDateString() %></td>
                                      </tr>
                                  <% }) %>
                              <% } else { %>
                                  <tr>
                                      <td colspan="7" class="text-center">No delivered orders found.</td>
                                  </tr>
                              <% } %>
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      </div>
  </div>
  
  <script>
    $(document).ready(function () {
        // Show or hide custom date range based on selected report type
        $('input[name="reportType"]').on('change', function () {
            const isCustom = $(this).val() === 'custom';
            $('.custom-date-range').toggle(isCustom);
            
            // Clear start and end dates if not custom
            if (!isCustom) {
                $('#startDate').val('');
                $('#endDate').val('');
            }
        });
    
        // Download report in PDF format
        $('#downloadPDFBtn').on('click', function () {
            downloadReport('pdf');
        });
    
        // Download report in Excel format
        $('#downloadExcelBtn').on('click', function () {
            downloadReport('excel');
        });
    
        // Function to handle report downloading in the desired format
        function downloadReport(format) {
            const reportType = $('input[name="reportType"]:checked').val();
            const startDate = $('#startDate').val();
            const endDate = $('#endDate').val();
    
            // Validate custom date range
            if (reportType === 'custom') {
                if (!startDate || !endDate) {
                    alert("Please select both start and end dates for a custom report.");
                    return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    alert("The end date must be after the start date.");
                    return;
                }
            }
    
            // Toggle loading indicator
            toggleLoading(true);
            $('#errorMessage').hide(); // Hide previous error messages
    
            // AJAX request to download the report
            $.ajax({
                type: 'POST',
                url: format==="pdf"?"/admin/download-sales-report":"/admin/download-sales-report-excel",
                data: JSON.stringify({ reportType, startDate, endDate }),
                contentType: 'application/json',
                xhrFields: {
                    responseType: 'blob' // Expecting a binary response for file download
                },
                success: function (blob) {
                    const link = document.createElement('a');
                    const url = window.URL.createObjectURL(blob);
                    link.href = url;
                    link.download = `sales_report.${format === 'pdf' ? 'pdf' : 'xlsx'}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                },
                error: function (jqXHR) {
                    let errorMsg = `Failed to download the ${format.toUpperCase()} report.`;
                    if (jqXHR.responseText) {
                        errorMsg += `: ${jqXHR.responseText}`; // Include server error message
                    }
                    $('#errorMessage').text(errorMsg).show(); // Display error message
                },
                complete: function () {
                    toggleLoading(false); // Turn off loading indicator
                }
            });
        }
    
        // Function to toggle loading indicator and disable/enable buttons
        function toggleLoading(isLoading) {
            $('#downloadPDFBtn, #downloadExcelBtn').prop('disabled', isLoading);
            $('#loadingIndicator').toggle(isLoading); // Show/hide loading indicator
        }
    });
</script>

    
  
  <%- include('../layouts/footer.ejs') %>
  